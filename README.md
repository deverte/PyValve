# PyValve
---
PyValve - программа-клиент, запрашивающая с сервера данные давления, а так же, управляющая экспериментальной установкой по определенному пользователем плану.

**Репозиторий архивирован и обновляться не будет.**

Возможности:
- Задание настроек
- Инициализация команд
- Составление плана эксперимента
- Исполнение команд согласно плану и сохранение данных с датчиков

## Содержание:
1. [Техническая информация](#Техническая-информация)
2. [Спецификация входных файлов](#Спецификация-входных-файлов)
    1. [settings]
    2. [plan]
    3. [commands]
3. [Спецификация выходных файлов](#Спецификация-выходных-файлов)
    1. [protocol]
    2. [pressures]
4. [License](#License)

## Техническая информация
Используемые библиотеки:
  - [pandas]
  - [requests]

## Спецификация входных файлов
---
### settings
Основные настройки сервера, входных и выходных файлов, настройки записи. Находится в корневой директории программы. Файл "settings.csv".

#### Блок SERVER
Настройки сервера.

Поля:
  - ip - ip-адрес сервера. Значение по умолчанию: http://192.168.1.54. __Важно__: в конце строки не нужно ставить знак "/" (т.е. писать http://192.168.1.54/), иначе строка неправильно обработается.
  - on - команда для включения реле. Значение по умолчанию: 1.
  - off - команда для выключения реле. Значение по умолчанию: 0.

#### Блок INPUT_FILES
Входные файлы.

Поля:
  - plan - файл плана работы установки. Значение по умолчанию: plan.csv. __Важно__: используется путь относительно корня программы. Подробнее см. [plan].
  - commands - файл спецификации команд. Значение по умолчанию: commands.csv. __Важно__: используется путь относительно корня программы. Подробнее см. [commands].

#### Блок OUTPUT_FILES
Выходные файлы.

Поля:
  - protocol - файл для записи протокола измерений. Значение по умолчанию: protocols/protocol.csv. __Важно__: используется путь относительно корня программы. Подробнее см. [protocol].
  - pressures - файл для записи давлений. Значение по умолчанию: pressures/pressures.csv. __Важно__: используется путь относительно корня программы. Подробнее см. [pressures].

#### Блок RECORDING
Параметры записи давлений.

Поля:
  - sample rate - частота записи давлений в файл (в секундах). Значение по умолчанию: 0.25. Подробнее см. [pressures].
  - time precision - количество знаков после запятой у времени, которое записывается в файл давлений. Значение по умолчанию: 3.
  - pressure precision - количество знаков после запятой у давлений, которое записываетяс в файл давлений, а так же, критериальное значение показателя степени для давлений в режиме приоритета давлений (см. [plan/Priority]). Значение по умолчанию: 3. Подробнее см. [pressures].

---
### plan
План работы установки. Путь к файлу устанавливается в файле настроек. Значение по умолчанию "plan.csv".

#### Колонки
##### Action
Действие (команда), понятная человеку, посылаемая серверу согласно файлу команд в формате "Command" (см. [commands]).
Пример: если Action = CO,

```
plan.csv
```

| Action | ... |
| ------ | ------ |
| ... |  |
| CO |  |
| ... |  |

тогда производится поиск данной команды в файле команд,

```
commands.csv
```

| Command | Signal |
| ------ | ------ |
| ... |  |
| CO | 0010000000 |
| ... |  |

и происходит преобразование команды, понятной человеку, в команду, понятную серверу (в данном случае, "CO" преобразуется в "0010000000"). Далее, команда выполняется на сервере, учитывая остальные параметры в колонках "Type", "Duration" и т.д.

Так же, существуют дополнительные действия, не присутствующие в файле команд, которые влияют на корректность обработки плана.

Команда repeat - повторение блока команд определенное количество раз. Количество повторений записывается в колонке "Type".

Пример:

```
plan.csv
```

| Action | Type | ... |
| ------ | ------ | ------ |
| ac1 | t1 |  |
| ac2 | t2 |  |
| repeat | 2 |  |
| ac3 | t3 |  |
| repeat | 3 |  |

преобразуется в

```
extended_plan
```

| Action | Type | ... |
| ------ | ------ | ------ |
| ac1 | t1 |  |
| ac2 | t2 |  |
| ac1 | t1 |  |
| ac2 | t2 |  |
| ac3 | t3 |  |
| ac3 | t3 |  |
| ac3 | t3 |  |

##### Type
Тип действия. Если действие "repeat", то в поле "Type" записывается количество повторений (см. [plan/Action]). Если действие находится в файле команд, то тип - модификатор, или комбинация модификаторов (см. [commands]).

Пример 1:
Даны:
```
plan.csv
```

| Action | Type | ... |
| ------ | ------ | ------ |
| ... |  |  |
| O2 | flow |  |
| ... |  |  |

и

```
commands.csv
```

| Command | Signal | Modifier |
| ------ | ------ | ------ |
| O2 | 0100000000 |  |
| flow | 0000000010 | Yes |

В итоге, программа выполнит сложение сигналов, и отправит серверу команду "0100000010".

Пример 2:
Даны:

```
plan.csv
```

| Action | Type | ... |
| ------ | ------ | ------ |
| ... |  |  |
| O2 | flow+slow |  |
| ... |  |  |

и

```
commands.csv
```

| Command | Signal | Modifier |
| ------ | ------ | ------ |
| O2 | 0100000000 |  |
| flow | 0000000010 | Yes |
| slow | 0000000100 | Yes |

Программа учтет два модификатора и отправит серверу команду "0100000110". __Важно__: программа проверяет вхождение строк команд в строку типа, поэтому не важно, как команды записаны в колонке типа. То есть, "flow+slow" = "flow_slow" = "flowslow" и т.д. Но следует быть осторожным с выбором команд, так как при

```
plan.csv
```

| Action | Type | ... |
| ------ | ------ | ------ |
| ... |  |  |
| O2 | flow |  |
| ... |  |  |

и

```
commands.csv
```

| Command | Signal | Modifier |
| ------ | ------ | ------ |
| O2 | 0100000000 |  |
| flow | 0000000010 | Yes |
| low | 0111111100 | Yes |

на выходе выдаст команду "0111111110", хотя подразумевалось "0100000010".

##### Duration
Длительность действия. Записывается в формате HH:MM:SS, где HH - часы, MM - минуты, SS - секунды (например, 00:10:30 значит, что действие будет выполняться 10 минут 30 секунд). В самом начале дейсвтия, всем реле поступает сигнал выключения, а затем сразу же поступает сигнал действия согласно плану. После всех действий, всем реле поступает сигнал выключения.

##### Priority
Приоритет завершения действия. Если значение равно "p" (от английского pressure), то действие завершится при превышении заданного давления (см. [plan/Pressure]) на заданном канале (см. [plan/Channel]). __Важно__: длительность действия все равно ограничено "Duration". Если значение пустое (не равно "p"), то действие будет ограничено только "Duration".

##### Pressure
Верхняя граница давления на заданном канале (см. [plan/Channel]), при котором завершается действие. Влияет только если стоит приоритет по давлению (см. [plan/Priority]).

##### Channel
Номер канала, по которому определяется верхний порог давления. Влияет только если стоит приоритет по давлению (см. [plan/Priority]).

---
### commands
Спецификация команд. Путь к файлу устанавливается в файле настроек. Значение по умолчанию "commands.csv".

#### Колонки
##### Command
Действие (команда), понятная человеку. Преобразуется в команду, понятную серверу (см. [commands/Signal]). Про преобразование команд см. [plan/Action].

##### Signal
Команда, понятная серверу. Сервер использует команды вида jihgfedcba, где a - первое (нулевое) реле, b - второе (первое) реле и т.д. В скобках указан разряд согласно двоичной системе счисления (bin). a, b, c...j могут принимать значения 0 и 1. В файле настроек указывается, какое значение соответствует включенному реле, а какое - выключенному (см. [settings]). В общем случае, 0 - выключенное реле, 1 - включенное. Если нужно инвертировать систему команд, то необходимо изменить значение on на 0, значение off на 1.
Пример:
Команда 0100010000

| bin | 9 | 8 | 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
| --- | - | - | - | - | - | - | - | - | - | - |
| Команда | 0 | 1 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 |

означает, что идет обращение к четвертому и восьмому реле.

##### Modifier
Является ли команда модификатором. Значение Yes означает, что программа будет обрабатывать данную команду как модификатор. Если значения нет (не Yes), то программа будет обрабатывать данную команду как обычное действие. Про использование модификаторов см. [plan/Type].

## Спецификация выходных файлов
---
### protocol
Протокол, записываемый во время исполнения программы. Путь к файлу устанавливается в файле настроек. Значение по умолчанию "protocols/protocol.csv".

#### Колонки
##### Action
Действие, выполненное согласно плану (см. [plan]).

##### Type
Тип действия согласно плану (см. [plan]).

##### Begin
Время (в секундах), когда действие начало выполняться относительно начала работы программы (см. [plan]).

##### Priority
Приоритет завершения действия (см. [plan]).

##### Pressure
Верхняя граница давления на заданном канале, при котором завершилось действие (только если стоял приоритет по давлению (см. [plan])).

##### Channel
Номер канала, по которому определялся верхний порог давления (только если стоял приоритет по давлению (см. [plan])).

---
### pressures
Давления, записываемые во время исполнения программы. Путь к файлу устанавливается в файле настроек. Значение по умолчанию "pressures/pressures.csv".

#### Колонки
##### Time
Момент времени (в секундах), когда происходило измерение давлений.

##### n
Давление на канале n в определенный момент времени (n - номер канала, с которого происходила запись давления. Принимает значения от 0 до N, где N - количество каналов минус один). Таких колонок N+1 штука.

## License

MIT

[//]: # (Reference links)

   [pandas]: <http://pandas.pydata.org/>
   [requests]: <http://docs.python-requests.org/en/master/>

   [plan]: <#plan>
   [commands]: <#commands>
   [protocol]: <#protocol>
   [pressures]: <#pressures>
   [settings]: <#settings>

   [plan/Priority]: <#Priority>
   [plan/Action]: <#Action>
   [plan/Pressure]: <#Pressure>
   [plan/Channel]: <#Channel>
   [plan/Type]: <#Type>
   [commands/Signal]: <#Signal>
